<style>
  body { font-family: monospace; padding: 1rem 2rem; }
  table { border-collapse: collapse; width: 100%; }
  th, td { border: 1px solid #ccc; padding: 0.25rem 0.5rem; text-align: left; font-size: 0.9em; }
  th { background: #eee; }
  .ok { color: green; } .warn { color: orange; } .err { color: red; }
  h2 { margin: 2rem 0 0.3rem; font-size: 1.1em; }
  .note { font-size: 0.8em; color: #888; margin: 0 0 0.5rem; }
  .ellip { max-width: 28em; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .rm button { font-family: monospace; cursor: pointer; color: #c00; background: none;
               border: 1px solid #c00; padding: 0 3px; border-radius: 2px; font-size: 0.85em; }
  .add-form { display: flex; gap: 0.4rem; margin-top: 0.5rem; }
  .add-form input { font-family: monospace; padding: 0.2rem 0.4rem; border: 1px solid #ccc; font-size: 0.9em; }
  .add-form button { font-family: monospace; padding: 0.2rem 0.5rem; cursor: pointer; font-size: 0.9em; }
  .cols { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; align-items: start; }
  .flash { padding: 0.3rem 0.6rem; margin-bottom: 0.5rem; border-radius: 2px; }
  .flash-notice { background: #e6f4ea; color: #1a7f37; }
  .flash-alert  { background: #fde8e8; color: #c00; }
</style>

<h1>Admin</h1>

<% if notice.present? %><p class="flash flash-notice"><%= notice %></p><% end %>
<% if alert.present? %><p class="flash flash-alert"><%= alert %></p><% end %>

<% if @error %>
  <p class="err">Error: <%= @error %></p>
<% else %>

<%# ── BANS — TWO COLUMNS ───────────────────────────────── %>
<div class="cols">
  <div>
    <h2>Auto-bans (<%= @auto_banned.size %>)</h2>
    <p class="note">Expire after 30 days. Stored in <code>storage/banned_ips.txt</code>.</p>
    <% if @auto_banned.any? %>
      <table>
        <tr><th>IP</th><th>Banned</th><th>Reason</th><th>UA</th><th></th></tr>
        <% @auto_banned.each do |ip, e| %>
          <tr>
            <td><%= ip %></td>
            <td><%= e[:banned_at].strftime("%m-%d %H:%M") %></td>
            <td><%= e[:reason] %></td>
            <td class="ellip" title="<%= e[:ua] %>"><%= e[:ua].truncate(60) %></td>
            <td class="rm"><%= form_with url: admin_remove_auto_ban_path, method: :post, local: true do |f| %><%= f.hidden_field :ip, value: ip %><%= f.submit "x" %><% end %></td>
          </tr>
        <% end %>
      </table>
    <% else %>
      <p class="note">None yet.</p>
    <% end %>
  </div>

  <div>
    <h2>Manual bans (<%= @manual_bans.size %>)</h2>
    <p class="note">Config = <code>config/manual_bans.txt</code> (deploy to change). Runtime = <code>storage/manual_bans.txt</code> (edit here).</p>
    <% if @manual_bans.any? %>
      <table>
        <tr><th>IP / CIDR</th><th>Source</th><th>Comment</th><th></th></tr>
        <% @manual_bans.each do |b| %>
          <tr>
            <td><%= b[:ip] %></td>
            <td><%= b[:source] %></td>
            <td><%= b[:comment] %></td>
            <td class="rm">
              <% if b[:source] == "runtime" %>
                <%= form_with url: admin_remove_manual_ban_path, method: :post, local: true do |f| %><%= f.hidden_field :ip, value: b[:ip] %><%= f.submit "x" %><% end %>
              <% end %>
            </td>
          </tr>
        <% end %>
      </table>
    <% end %>
    <%= form_with url: admin_add_manual_ban_path, method: :post, local: true do |f| %>
      <div class="add-form">
        <%= f.text_field :ip, placeholder: "1.2.3.4 or 10.0.0.0/8", size: 22 %>
        <%= f.text_field :comment, placeholder: "reason (optional)", size: 22 %>
        <%= f.submit "Ban" %>
      </div>
    <% end %>
  </div>
</div>

<%# ── MEILISEARCH ─────────────────────────────────────────── %>
<h2>Indices (<%= (@global_stats["databaseSize"].to_f / 1024**3).round(2) %> GB total)</h2>
<table>
  <tr><th>Index</th><th>Docs</th><th>Indexing?</th></tr>
  <% @global_stats["indexes"]&.each do |name, idx| %>
    <tr>
      <td><%= name %></td>
      <td><%= idx["numberOfDocuments"] %></td>
      <td class="<%= idx["isIndexing"] ? "warn" : "ok" %>"><%= idx["isIndexing"] ? "yes" : "no" %></td>
    </tr>
  <% end %>
</table>

<h2>Recent Tasks (last 20)</h2>
<table>
  <tr><th>UID</th><th>Index</th><th>Type</th><th>Status</th><th>Enqueued</th><th>Duration</th><th>Error</th></tr>
  <% @tasks.each do |t| %>
    <% status_class = { "succeeded" => "ok", "failed" => "err", "processing" => "warn", "enqueued" => "" }[t["status"]] %>
    <tr>
      <td><%= t["uid"] %></td>
      <td><%= t["indexUid"] %></td>
      <td><%= t["type"] %></td>
      <td class="<%= status_class %>"><%= t["status"] %></td>
      <td><%= t["enqueuedAt"]&.sub("T", " ")&.first(19) %></td>
      <td><%= format_iso8601_duration(t["duration"]) %></td>
      <td class="ellip"><%= t.dig("error", "message")&.truncate(80) %></td>
    </tr>
  <% end %>
</table>

<% end %>
