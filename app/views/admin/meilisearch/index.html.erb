<style>
  body { font-family: monospace; padding: 1rem 2rem; }
  table { border-collapse: collapse; width: 100%; margin-bottom: 2rem; }
  th, td { border: 1px solid #ccc; padding: 0.3rem 0.6rem; text-align: left; }
  th { background: #eee; }
  .ok { color: green; } .warn { color: orange; } .err { color: red; }
  h2 { margin-top: 2rem; }
  .top-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem; }
  .top-grid table { margin-bottom: 0; }
</style>

<h1>Meilisearch Admin</h1>

<% if @error %>
  <p class="err">Error: <%= @error %></p>
<% else %>

<div class="top-grid">
  <div>
    <h2 style="margin-top:0">Rack::Attack</h2>
    <p>Enabled: <span class="<%= @rack_attack_enabled ? "ok" : "warn" %>"><%= @rack_attack_enabled %></span></p>
  </div>

  <div>
    <h2 style="margin-top:0">Auto-banned IPs (<%= @ip_auto_banned.size %>, expire after 30d)</h2>
    <p style="font-size:0.85em;color:#666">Manual bans: <%= @ip_manual_banned %> entries in storage/manual_bans.txt</p>
    <% if @ip_auto_banned.any? %>
      <table>
        <% @ip_auto_banned.each do |ip, banned_at| %>
          <tr><td><%= ip %></td><td style="color:#999"><%= banned_at.strftime("%Y-%m-%d") %></td></tr>
        <% end %>
      </table>
    <% else %>
      <p>None yet.</p>
    <% end %>
  </div>
</div>

<h2>Indices</h2>
<p style="font-size:0.85em;color:#666">Per-index disk usage is not exposed by the Meilisearch API â€” only total DB size is available.</p>
<table>
  <tr><th>Index</th><th>Docs</th><th>Indexing?</th></tr>
  <% @global_stats["indexes"]&.each do |name, idx| %>
    <tr>
      <td><%= name %></td>
      <td><%= idx["numberOfDocuments"] %></td>
      <td class="<%= idx["isIndexing"] ? "warn" : "ok" %>"><%= idx["isIndexing"] ? "yes" : "no" %></td>
    </tr>
  <% end %>
  <tr><th colspan="2">Total DB size</th><td><%= (@global_stats["databaseSize"].to_f / 1024**3).round(2) %> GB</td></tr>
</table>

<h2>Recent Tasks (last 20)</h2>
<table>
  <tr><th>UID</th><th>Index</th><th>Type</th><th>Status</th><th>Enqueued</th><th>Duration</th><th>Error</th></tr>
  <% @tasks.each do |t| %>
    <% status_class = { "succeeded" => "ok", "failed" => "err", "processing" => "warn", "enqueued" => "" }[t["status"]] %>
    <tr>
      <td><%= t["uid"] %></td>
      <td><%= t["indexUid"] %></td>
      <td><%= t["type"] %></td>
      <td class="<%= status_class %>"><%= t["status"] %></td>
      <td><%= t["enqueuedAt"]&.sub("T", " ")&.first(19) %></td>
      <td><%= format_iso8601_duration(t["duration"]) %></td>
      <td><%= t.dig("error", "message")&.truncate(80) %></td>
    </tr>
  <% end %>
</table>

<% end %>
