<style>
  body { font-family: monospace; padding: 1rem 2rem; }
  table { border-collapse: collapse; width: 100%; margin-bottom: 1rem; }
  th, td { border: 1px solid #ccc; padding: 0.3rem 0.6rem; text-align: left; }
  th { background: #eee; }
  .ok { color: green; } .warn { color: orange; } .err { color: red; }
  h2 { margin-top: 2rem; border-bottom: 1px solid #ddd; padding-bottom: 0.2rem; }
  .note { font-size: 0.85em; color: #666; margin: 0.3rem 0 0.7rem; }
  .rm { font-size: 0.8em; }
  .rm button { font-family: monospace; cursor: pointer; color: #c00; background: none;
               border: 1px solid #c00; padding: 0 4px; border-radius: 2px; }
  .add-form { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
  .add-form input { font-family: monospace; padding: 0.2rem 0.4rem; border: 1px solid #ccc; }
  .add-form button { font-family: monospace; padding: 0.2rem 0.6rem; cursor: pointer; }
  .flash-notice { color: green; } .flash-alert { color: red; }
</style>

<h1>Admin</h1>

<% if notice.present? %><p class="flash-notice"><%= notice %></p><% end %>
<% if alert.present? %><p class="flash-alert"><%= alert %></p><% end %>

<% if @error %>
  <p class="err">Error: <%= @error %></p>
<% else %>

<p>Rack::Attack: <strong class="<%= @rack_attack_enabled ? "ok" : "warn" %>"><%= @rack_attack_enabled ? "enabled" : "disabled" %></strong></p>

<%# ── AUTO-BANNED ────────────────────────────────────────── %>
<h2>Auto-bans (<%= @auto_banned.size %>)</h2>
<p class="note">Expire after 30 days. Persisted in <code>storage/banned_ips.txt</code>.</p>
<% if @auto_banned.any? %>
  <table>
    <tr><th>IP</th><th>Banned</th><th>Reason</th><th>User-Agent</th><th></th></tr>
    <% @auto_banned.each do |ip, e| %>
      <tr>
        <td><%= ip %></td>
        <td><%= e[:banned_at].strftime("%Y-%m-%d %H:%M") %></td>
        <td><%= e[:reason] %></td>
        <td style="max-width:30em;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="<%= e[:ua] %>"><%= e[:ua].truncate(80) %></td>
        <td class="rm">
          <%= form_with url: admin_remove_auto_ban_path, method: :post, local: true do |f| %>
            <%= f.hidden_field :ip, value: ip %>
            <%= f.submit "remove" %>
          <% end %>
        </td>
      </tr>
    <% end %>
  </table>
<% else %>
  <p class="note">None yet.</p>
<% end %>

<%# ── RUNTIME MANUAL BANS ────────────────────────────────── %>
<h2>Manual bans — runtime (<%= @runtime_bans.size %>)</h2>
<p class="note">Editable here. Written to <code>storage/manual_bans.txt</code>, survives deploys.</p>
<% if @runtime_bans.any? %>
  <table>
    <tr><th>IP / CIDR</th><th></th></tr>
    <% @runtime_bans.each do |raw| %>
      <tr>
        <td><%= raw %></td>
        <td class="rm">
          <%= form_with url: admin_remove_manual_ban_path, method: :post, local: true do |f| %>
            <%= f.hidden_field :ip, value: raw %>
            <%= f.submit "remove" %>
          <% end %>
        </td>
      </tr>
    <% end %>
  </table>
<% end %>
<%= form_with url: admin_add_manual_ban_path, method: :post, local: true do |f| %>
  <div class="add-form">
    <%= f.text_field :ip, placeholder: "1.2.3.4 or 1.2.0.0/16", size: 30 %>
    <%= f.submit "Ban" %>
  </div>
<% end %>

<%# ── CONFIG MANUAL BANS ─────────────────────────────────── %>
<h2>Manual bans — config (<%= @config_bans.size %>)</h2>
<p class="note">Read-only. Defined in <code>config/manual_bans.txt</code> — deploy to change.</p>
<% if @config_bans.any? %>
  <table>
    <tr><th>IP / CIDR</th></tr>
    <% @config_bans.each do |raw| %>
      <tr><td><%= raw %></td></tr>
    <% end %>
  </table>
<% end %>

<%# ── MEILISEARCH ─────────────────────────────────────────── %>
<h2>Indices</h2>
<p class="note">Per-index disk usage is not available via the Meilisearch API — only total DB size.</p>
<table>
  <tr><th>Index</th><th>Docs</th><th>Indexing?</th></tr>
  <% @global_stats["indexes"]&.each do |name, idx| %>
    <tr>
      <td><%= name %></td>
      <td><%= idx["numberOfDocuments"] %></td>
      <td class="<%= idx["isIndexing"] ? "warn" : "ok" %>"><%= idx["isIndexing"] ? "yes" : "no" %></td>
    </tr>
  <% end %>
  <tr><th colspan="2">Total DB size</th><td><%= (@global_stats["databaseSize"].to_f / 1024**3).round(2) %> GB</td></tr>
</table>

<h2>Recent Tasks (last 20)</h2>
<table>
  <tr><th>UID</th><th>Index</th><th>Type</th><th>Status</th><th>Enqueued</th><th>Duration</th><th>Error</th></tr>
  <% @tasks.each do |t| %>
    <% status_class = { "succeeded" => "ok", "failed" => "err", "processing" => "warn", "enqueued" => "" }[t["status"]] %>
    <tr>
      <td><%= t["uid"] %></td>
      <td><%= t["indexUid"] %></td>
      <td><%= t["type"] %></td>
      <td class="<%= status_class %>"><%= t["status"] %></td>
      <td><%= t["enqueuedAt"]&.sub("T", " ")&.first(19) %></td>
      <td><%= format_iso8601_duration(t["duration"]) %></td>
      <td><%= t.dig("error", "message")&.truncate(80) %></td>
    </tr>
  <% end %>
</table>

<% end %>
