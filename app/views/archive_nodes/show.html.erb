<div class="search-bar">
  <nav class="browse-tabs">
    <%= link_to browse_fonds_path, class: "browse-tabs__tab browse-tabs__tab--active" do %>
      <%= t("browse.fonds") %> <span class="browse-tabs__count"><%= @browse_counts[:fonds] %></span>
    <% end %>
    <%= link_to browse_origins_path, class: "browse-tabs__tab" do %>
      <%= t("browse.origins") %> <span class="browse-tabs__count"><%= @browse_counts[:origins] %></span>
    <% end %>
    <%= link_to browse_dates_path, class: "browse-tabs__tab" do %>
      <%= t("browse.dates") %> <span class="browse-tabs__count"><%= @browse_counts[:decades] %></span>
    <% end %>
  </nav>
  <form class="search-bar__form" action="<%= root_path %>">
    <input type="hidden" name="node_id" value="<%= @archive_node.id %>" />
    <input type="text" name="q" placeholder="In diesem Bestand suchen..." class="search__text-input" />
    <input type="submit" value="Suchen" class="search__button" />
  </form>
</div>

<nav class="archive-node-menu">
  <% @levels.each_with_index do |nodes, level_index| %>
    <ul class="archive-node-level" style="--level: <%= level_index %>">
      <% nodes.each do |node| %>
        <% 
          # A node is "selected" if it is the current node OR if it is a parent of the current node
          # (i.e. its ID appears in the current level's path toward the current node)
          is_current = node.id == @archive_node.id
          is_parent = @parents.any? { |p| p.id == node.id }
          is_selected = is_current || is_parent
          
          # We don't have child_nodes count directly here without more queries, 
          # but we can guess level behavior or just use a generic style.
          # For now, let's treat everything as a "tree" unless we know otherwise.
        %>
        <li class="archive-node <%= "archive-node--selected" if is_selected %> archive-node--tree">
          <%= link_to archive_node_path(node.id), class: 'archive-node__link' do %>
            <% if node.unitid.present? %><span class="archive-node__unitid"><%= node.unitid %></span><% end %>
            <%= node.name %>
            <% if (count = @file_counts[node.id]) && count > 0 %>
              <span class="archive-node__count"><%= count %></span>
            <% end %>
          <% end %>
        </li>
      <% end %>
    </ul>
  <% end %>
</nav>

<% 
  has_grid_data = @archive_node.unitdate.present? || 
                  (@archive_node.physdesc.present? && (@archive_node.physdesc['genreform'].present? || @archive_node.physdesc['extent']&.any?)) ||
                  @archive_node.langmaterial.present? ||
                  (@archive_node.origination.present? && @archive_node.origination.any?) ||
                  (@archive_node.repository.present? && @archive_node.repository['corpname'].present?)
  
  has_sections = @archive_node.scopecontent.present? || 
                 @archive_node.relatedmaterial.present? || 
                 @archive_node.prefercite.present?
  
  has_details = has_grid_data || has_sections
%>

<% if has_details %>
  <div class="archive-node-details">
    <h1 class="archive-node-details__title">
      <% if @archive_node.unitid.present? %><span class="archive-node__unitid"><%= @archive_node.unitid %></span><% end %>
      <%= @archive_node.name %>
    </h1>

    <% if has_grid_data %>
      <div class="archive-node-details__grid">
        <% if @archive_node.unitdate.present? %>
          <div class="archive-node-details__item">
            <strong><%= t('archive_node.unitdate') %>:</strong> <%= @archive_node.unitdate %>
          </div>
        <% end %>

        <% if @archive_node.physdesc.present? && (@archive_node.physdesc['genreform'].present? || @archive_node.physdesc['extent']&.any?) %>
          <div class="archive-node-details__item">
            <strong><%= t('archive_node.physdesc') %>:</strong>
            <%= @archive_node.physdesc['genreform'] %>
            <% if @archive_node.physdesc['extent']&.any? %>
              (<%= @archive_node.physdesc['extent'].join(', ') %>)
            <% end %>
          </div>
        <% end %>

        <% if @archive_node.langmaterial.present? %>
          <div class="archive-node-details__item">
            <strong><%= t('archive_node.langmaterial') %>:</strong> <%= @archive_node.langmaterial %>
          </div>
        <% end %>

        <% if @archive_node.origination.present? && @archive_node.origination.any? %>
          <div class="archive-node-details__item">
            <strong><%= t('archive_node.origination') %>:</strong>
            <%= @archive_node.origination.map { |o| o['name'] }.join(', ') %>
          </div>
        <% end %>

        <% if @archive_node.repository.present? && @archive_node.repository['corpname'].present? %>
          <div class="archive-node-details__item">
            <strong><%= t('archive_node.repository') %>:</strong>
            <%= @archive_node.repository['corpname'] %>
            <% if @archive_node.repository['address']&.any? %>
              - <%= @archive_node.repository['address'].join(', ') %>
            <% end %>
          </div>
        <% end %>
      </div>
    <% end %>

    <% if @archive_node.scopecontent.present? %>
      <div class="archive-node-details__section">
        <h2><%= t('archive_node.scopecontent') %></h2>
        <div class="archive-node-details__text"><%= simple_format(@archive_node.scopecontent) %></div>
      </div>
    <% end %>

    <% if @archive_node.relatedmaterial.present? %>
      <div class="archive-node-details__section">
        <h2><%= t('archive_node.relatedmaterial') %></h2>
        <div class="archive-node-details__text"><%= simple_format(@archive_node.relatedmaterial) %></div>
      </div>
    <% end %>

    <% if @archive_node.prefercite.present? %>
      <div class="archive-node-details__section">
        <h2><%= t('archive_node.prefercite') %></h2>
        <div class="archive-node-details__text"><%= simple_format(@archive_node.prefercite) %></div>
      </div>
    <% end %>
  </div>
<% else %>
  <h1 class="archive-node-title-only">
    <% if @archive_node.unitid.present? %><span class="archive-node__unitid"><%= @archive_node.unitid %></span><% end %>
    <%= @archive_node.name %>
  </h1>
<% end %>

<% if @archive_files.any? %>
  <div class="archive-node-files">
    <% @archive_files.each do |archive_file| %>
      <%= render ResultComponent.new(archive_file: archive_file) %>
    <% end %>
  </div>
<% end %>

<script>
  document.querySelectorAll('.archive-node--selected').forEach((el) => {
    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
  });
</script>
